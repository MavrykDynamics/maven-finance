---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
spec:
  schedule: '0 1 * * *'
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
            - name: backup-pv-storage
              persistentVolumeClaim:
                claimName: mavryk-indexer-backup
            - name: backup-script
              configMap:
                name: backup-script
          containers:
            - name: backup
              image: postgres:alpine
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: backup-pv-storage
                  mountPath: /usr/indexer-backup
                - name: backup-script
                  mountPath: /backup.sh
                  subPath: backup.sh
              command:
                - /bin/sh
                - -c
                - /backup.sh
              env:
                - name: PGHOST
                  valueFrom:
                    secretKeyRef:
                      name: indexer
                      key: POSTGRES_HOST
                - name: PGPORT
                  valueFrom:
                    secretKeyRef:
                      name: indexer
                      key: POSTGRES_PORT
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: indexer
                      key: POSTGRES_USERNAME
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: indexer
                      key: POSTGRES_PASSWORD
                - name: BACKUP_RETENTION_IN_DAYS
                  value: '7'
                - name: BACKUP_FOLDER
                  value: '/usr/indexer-backup'
          restartPolicy: OnFailure
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mavryk-indexer-backup
spec:
  storageClassName: do-block-storage
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
data:
  backup.sh: |
    #!/bin/bash

    # Create variables
    RETENTION_IN_DAYS=$BACKUP_RETENTION_IN_DAYS
    TIMESTAMP=$(date +%s)
    DATETIME=$(date +"%Y-%m-%d")
    FILE_NAME=$TIMESTAMP-$DATETIME-mavryk-indexer-dump.sql

    echo âŒ› Retention in days set to $RETENTION_IN_DAYS

    # Clean past backups to only keep seven of them
    FILEARR=()
    for FILE in $BACKUP_FOLDER/*
    do
        # echo $FILE
        FILEARR+=($FILE)
    done

    echo ðŸ—‘ï¸ Cleaning the past backups

    COUNTER=1
    for ((i=${#FILEARR[@]}-1; i>=0; i--))
    do
      if [ "$COUNTER" -gt "$RETENTION_IN_DAYS" ]
      then
        echo "${FILEARR[$i]}"
        rm ${FILEARR[$i]}
      else
        ((COUNTER=COUNTER+1))
      fi
    done

    # Creates a new backup
    echo ðŸ’¾ Creating a new backup: $BACKUP_FOLDER/$FILE_NAME
    pg_dump -h $PGHOST -p $PGPORT -U $PGUSER -f $BACKUP_FOLDER/$FILE_NAME -d dipdup
