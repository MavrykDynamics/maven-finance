{{- range $key, $value := .Values.instances }}
{{- if $value.dipdup.initialWipe }}
---
apiVersion: v1
kind: Pod
metadata:
  name: wipe-{{ $key }}-database-{{ now | unixEpoch }}
spec:
  restartPolicy: Never
  imagePullSecrets:
    - name: '{{ $value.dipdup.image.pullSecret }}'
  containers:
    - name: wipe-dipdup-database
      args: ['-c', 'dipdup.yml', '-c', 'dipdup.contract.yml', '-c', 'dipdup.wipe.yml', 'schema', 'wipe', '--force']
      env:
      {{- range $value.dipdup.env }}
        - name: {{ .name }}
          {{- if ((.value))}}
          value: "{{.value}}"
          {{- else }}
          valueFrom:
            secretKeyRef:
              name: {{ .valueFrom.secretKeyRef.name }}
              key: {{ .valueFrom.secretKeyRef.key }}
          {{- end }}
      {{- end }}
      image: '{{ $value.dipdup.image.registry }}/{{ $value.dipdup.image.repository }}:{{ $value.dipdup.image.tag }}'
      imagePullPolicy: '{{ $value.dipdup.image.pullPolicy }}'
{{- end }}
{{- end }}
