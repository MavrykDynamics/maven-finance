---
apiVersion: v1
kind: Service
metadata:
  name: oracle
  labels:
    app: oracle
spec:
  ports:
    - name: signatory
      port: 6732
      protocol: TCP
      targetPort: signatory
    - name: p2p
      port: 23456
      protocol: TCP
      targetPort: p2p
  selector:
    app: oracle
  type: ClusterIP
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: oracle-config
data:
  secret.json: |
    [
      {
        "name": "bobPeerId",
        "value": "edskSA1MhTp6Eq3T79MEP822eXAmxXBk89eFYGgwBsJjfyUHDGsYfudasQocwcb5DUEMvA1B3EsvxCZ8G6Wek6syxAA49DEKzq"
      }
    ]
  signatory.yaml: |
    server:
      # Address/Port that Signatory listens on
      address: :6732
      # Address/Port that Signatory serves prometheus metrics on
      utility_address: :9583

    vaults:
      # Name of vault
      # THIS IS NOT RECOMMENDED FOR PRODUCTION, Use local key storage for testing/development only.
      local_file_keys:
        driver: file
        config:
          file: /etc/signatory/secret.json

    # List enabled public keys hashes here
    tezos:
      tz1ezDb77a9jaFMHDWs8QXrKEDkpgGdgsjPD: # Your tezos address
        log_payloads: true
        allowed_operations:
          # List of [generic, block, endorsement]
          - generic
          - block
          - endorsement
          - failing_noop
        allowed_kinds:
          # List of [endorsement, ballot, reveal, transaction, origination, delegation, seed_nonce_revelation, activate_account]
          - transaction
          - endorsement
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oracle
  labels:
    app: oracle
spec:
  replicas: 1
  selector:
    matchLabels:
      app: oracle
  template:
    metadata:
      labels:
        app: oracle
    spec:
      imagePullSecrets:
        - name: 'docker-pull-credentials'
      volumes:
        - name: oracle-config
          projected:
            sources:
              - configMap:
                  name: oracle-config
      containers:
        - name: oracle
          env:
            - name: RPC_URL
              value: 'https://uoi3x99n7c.ghostnet.tezosrpc.midl.dev'
            - name: SIGNER_URL
              value: 'http://oracle.mavryk-oracles.svc.cluster.local:6732'
            - name: P2P_BOOTSTRAP_PEERS
              value: ''
            - name: P2P_PEER_ID
              value: '12D3KooWJQWBQvefFGj3uAzKGhpZYWYGKtj2fNQAG47aov4uj9p1'
            - name: P2P_PEER_PUBLIC_KEY
              value: 'CAESIH+cTTTZ4gyqjEsn4L17gs9BTYU1ZeAnrBbUqQQQ9uW2'
            - name: P2P_PEER_PRIVATE_KEY
              value: 'CAESQENvWXyvlXtuw58TMrMF45ffJUza23h8zHSvssitueRgf5xNNNniDKqMSyfgvXuCz0FNhTVl4CesFtSpBBD25bY='
            - name: TEZOS_ADDRESS
              value: 'tz1ezDb77a9jaFMHDWs8QXrKEDkpgGdgsjPD'
            - name: TEZOS_PUBLIC_KEY
              value: 'edpktqePwpgrWGS49FiAMDacb3bLiDLE8BrbLoi6zYdcZ9bttDLo1D'
            - name: ALPHAVANTAGE_API_KEY
              secretKeyRef:
                name: api-keys
                key: ALPHAVANTAGE_API_KEY
            - name: MESSARI_API_KEY
              secretKeyRef:
                name: api-keys
                key: MESSARI_API_KEY
            - name: TEZOS_POLLING_INTERVAL_MILLISECONDS
              value: '2000'
            - name: AGGREGATOR_SMART_CONTRACT_ADDRESS
              value: 'KT1JgBX8LRJ7AmVhTk64niDZxfXH8UBXyiDv'
            - name: AGGREGATOR_PAIR_1
              value: 'USD'
            - name: AGGREGATOR_PAIR_2
              value: 'BTC'
            - name: LOG_LEVEL
              value: 'verbose'
            - name: USE_FAKE_DATA
              value: 'false'
          image: 'mavrykdynamics/mavryk-oracle:v0.0.1'
          imagePullPolicy: 'Always'
          ports:
            - name: p2p
              containerPort: 23456
              protocol: TCP
        - name: signatory
          image: 'ecadlabs/signatory:v0.3.3-beta-rc1-amd64'
          imagePullPolicy: 'Always'
          args:
            - -c
            - /etc/signatory/signatory.yaml
          volumeMounts:
            - name: oracle-config
              mountPath: /etc/signatory
          ports:
            - name: signatory
              containerPort: 6732
              protocol: TCP
