{{- range $key, $value := .Values.instances }}
{{- if $value.dipdup.database.backup.enabled }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup-{{ $key }}
spec:
  schedule: '0 1 * * *'
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
            - name: backup-pv-storage
              persistentVolumeClaim:
                claimName: mavryk-finance-indexer-backup-{{ $key }}
            - name: backup-script
              configMap:
                name: backup-script-{{ $key }}
                defaultMode: 0755
          containers:
            - name: backup
              image: postgres:alpine
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: backup-pv-storage
                  mountPath: /usr/indexer-backup
                - name: backup-script
                  mountPath: /backup.sh
                  subPath: backup.sh
              command:
                - /bin/sh
                - -c
                - /backup.sh
              env:
              {{- range $value.dipdup.database.backup.env }}
                - name: {{ .name }}
                  {{- if ((.value))}}
                  value: "{{.value}}"
                  {{- else }}
                  valueFrom:
                    secretKeyRef:
                      name: {{ .valueFrom.secretKeyRef.name }}
                      key: {{ .valueFrom.secretKeyRef.key }}
                  {{- end }}
              {{- end }}
          restartPolicy: OnFailure
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mavryk-finance-indexer-backup-{{ $key }}
spec:
  storageClassName: do-block-storage
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script-{{ $key }}
data:
  backup.sh: |
    #!/bin/bash

    # Create variables
    RETENTION_IN_DAYS=$BACKUP_RETENTION_IN_DAYS
    TIMESTAMP=$(date +%s)
    DATETIME=$(date +"%Y-%m-%d")
    FILE_NAME=$TIMESTAMP-$DATETIME-mavryk-finance-indexer-dump.sql

    echo âŒ› Retention in days set to $RETENTION_IN_DAYS

    # Clean past backups to only keep seven of them
    FILEARR=()
    for FILE in $BACKUP_FOLDER/*
    do
        # echo $FILE
        FILEARR+=($FILE)
    done

    echo ðŸ—‘ï¸  Cleaning the past backups

    COUNTER=1
    for ((i=${#FILEARR[@]}-1; i>=0; i--))
    do
      if [ "$COUNTER" -gt "$RETENTION_IN_DAYS" ]
      then
        echo "${FILEARR[$i]}"
        rm ${FILEARR[$i]}
      else
        ((COUNTER=COUNTER+1))
      fi
    done

    # Creates a new backup
    echo ðŸ’¾ Creating a new backup: $BACKUP_FOLDER/$FILE_NAME
    pg_dump -h $PGHOST -p $PGPORT -U $PGUSER -f $BACKUP_FOLDER/$FILE_NAME -d $POSTGRES_DB
{{- end }}
{{- end }}
